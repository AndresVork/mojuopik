
# Sünteetilise võrdlusobjekti meetod

Synthetic control method (SCM)

## Taust

Selles peatükis käsitleme sünteetilise võrdlusobjekti meetodit (synthetic control method), mis on välja töötatud olukordadeks, kus meid huvitab ühe konkreetse agregeeritud objekti – näiteks riigi, regiooni või linna – kokkupuude mingi poliitika või sündmusega ning soovime hinnata selle mõju. Erinevalt klassikalisest erinevuste-vahe (dif-dif) lähenemisest, kus on palju meetmes osalejaid ja kontrollüksusi, on sünteetilise kontrolli meetodi fookuses sageli olukord, kus reaalselt on vaid üks meetmes osalev objekt ja piiratud arv sobivaid võrdlusobjekte.

Motivatsioon tuleneb tüüpilistest poliitikaküsimustest: mis oli Saksamaa taasühinemise mõju Lääne-Saksamaa majanduskasvule, milline oli California ulatusliku tubakakontrolliprogrammi mõju suitsetamisele või kuidas mõjutas Eesti kogumispensioni vabatahtlikuks muutmine majapidamiste tarbimist ja säästmist. Nendele küsimustele vastamiseks ei piisa sageli üksiku võrdlusriigi või -regiooni valimisest, sest subjektiivne valik võib kallutada tulemusi. Sünteetilise kontrolli meetod pakub süsteemse viisi sellise „võrdlusobjekti” konstrueerimiseks.

## Taust ja rakenduste näited

Empiirilises kirjanduses seostatakse sünteetilise kontrolli meetodit eelkõige Abadie ja kaastööliste töödega. Esimene tuntud rakendus on Abadie ja Gardeazabal (2003), kus hinnatakse Baskimaa konflikti majanduslikku hinda võrreldes sünteetiliselt konstrueeritud kontrollpiirkonnaga, mis on kaalutud kombinatsioon Hispaania teistest provintsidest. Abadie, Diamond ja Hainmueller (2010) meetodit California tubakakontrolliprogrammi mõjude hindamiseks ja Abadie, Diamond ja Hainmueller (2014) Saksamaa taasühinemise mõjude analüüsimiseks, konstrueerides Lääne-Saksamaale võrdluseks sünteetilise OECD riikide kombinatsiooni.

Eestis on meetodit kasutatud näiteks Centari analüüsis, kus hinnati lapsehoiu ja alushariduse projektide mõju koolieelsetes lasteasutustes käivate laste osakaalule ja naiste tööhõivele, moodustades sekkumispiirkondadele sobivad sünteetilised kontrollpiirkonnad. Samuti kasutab Meriküll (2025) sünteetilise dif-dif lähenemist, et hinnata, kuidas kogumispensioni varasem vabatahtlikuks muutmine mõjutas Eesti majapidamiste finantskäitumist ja inflatsiooni, võrreldes Eestit riikidega, kus sellist reformi ei olnud.

Need näited illustreerivad, et sünteetilise kontrolli meetod on kasulik just siis, kui mõjutatud üksusi on vähe ja me soovime vältida ad hoc ühe võrdlusriigi või -piirkonna valikut.

### Seade ja tähistused

Olgu meil $J + 1$ agregeeritud objekti: üks käsitletav objekt (näiteks California või Baskimaa) ning $J$ potentsiaalset kontrollobjekti (doonorgrupp). Ajalist dimensiooni tähistame perioodidega $t = 1, \dots, T$, kus sekkumine toimub alates ajast $T_0 + 1$. Perioodid $t \leq T_0$ on sekkumiseelsed, perioodid $t > T_0$ sekkumisjärgsed.

Olgu $Y_{it}$ objekt $i$ tegelik tulemusmuutuja (näiteks sigarettide müük elaniku kohta) perioodil $t$. Huvipakkuv on sekkumise mõju käsitletavale üksusele $i = 1$, mida defineerime kui vahe tegeliku tulemuse ja kontrafaktuaalse tulemuse vahel:

$$
\alpha_{1t} = Y_{1t}^{I} - Y_{1t}^{N}, \quad t > T_0,
$$

kus $Y_{1t}^{I}$ on tulemus sekkumisega (täheldatav) ning $Y_{1t}^{N}$ oleks tulemus ilma sekkumiseta (võrdlusseisund), mida otseselt ei näe.

Sünteetilise kontrolli idee seisneb selles, et võrdlusseisundi aegrida $Y_{1t}^{N}$ konstrueeritakse kontrollobjektide kaalutud keskmisena:

$$ Y\_{1t}\^{N} \approx \sum*{j=2}\^{J+1} w_j Y*{jt}, \quad t = 1, \dots, T, $$

kus kaalud $w_j \geq 0$ ja $\sum_{j=2}^{J+1} w_j = 1$. Need kaalud määravad „sünteetilise kontrolli”, ehk hüpoteetilise objekti, mis on kombinatsioon olemasolevatest võrdlusüksustest ja mille sekkumiseelse dünaamika soovime sobitada käsitletava objektiga võimalikult täpselt.

Sellisel juhul on mõju hinnang ajapunktis $t > T_0$:

$$ \hat{\alpha}*{1t} = Y*{1t} - \sum\_{j=2}\^{J+1} \hat{w}*j Y*{jt}. $$

Graafiliselt saame võrrelda käsitletava objekti tegelikku rada ning sünteetilise kontrolli rada, ning sekkumisejärgne erinevus nende vahel annab visuaalse ja kvantitatiivse hinnangu sekkumise mõjust.

### Selgitavad tunnused ja kaalud

Lisaks tulemusmuutujale kasutab meetod sobitamiseks selgitavaid tunnuseid ja sekkumiseelseid tulemusi. Olgu $X_1$ vektor käsitletava objekti tunnustest ja sekkumiseelsete tulemuste kokkuvõtlikest näitajatest (näiteks keskmised väärtused), ning $X_0$ maatriks samade tunnuste kohta kontrollobjektide jaoks:

\$\$ X_1 = (x\_{11}, \dots, x\_{1K})', \quad X_0 =

\begin{pmatrix}
x_{21} & \dots & x_{J+1,1} \\
\vdots & \ddots & \vdots \\
x_{2K} & \dots & x_{J+1,K}
\end{pmatrix}

\$\$

Lisaks kaaludele objektidele $w = (w_2, \dots, w_{J+1})'$ kasutatakse ka kaalusid tunnustele $V$, mis on diagonaalmaatriks suhtelise olulisusega tunnuste vahel. Intuitsioon on, et mõni tunnus – näiteks sekkumiseelsed tulemused – võib olla eriti informatiivne tulevase tulemuse kohta ning seetõttu saab suurema kaalu.

Kaalud valitakse nii, et sobitada käsitletava objekti tunnused võimalikult hästi sünteetilisele kontrollile, minimeerides sobituskao:

$$ \min\_{w} (X_1 - X_0 w)' V (X_1 - X_0 w) $$

võttes arvesse tingimusi $w_j \geq 0$ ja $\sum_j w_j = 1$. See miinimumväärtus ongi nn W-kaotus (W-loss), mis näitab, kui hästi suudame valitud $V$ korral sobitada selgitavad tunnused.

Seejärel valitakse $V$ nii, et minimeerida sekkumiseelsel perioodil sünteetilise kontrolli prognoosivea ruutkeskmine, ehk sekkumiseelne ruutkeskmine prognoosiviga (MSPE, Root Mean Square Prediction Error). See on seotud nn V-kaotusega (V-loss), ehk sellega, kui hästi sekkumiseelse väljundi rada on käsitletava objekti ja sünteetilise kontrolli vahel ühtiv.

### California tubakakontrolli programmi näide

Üks klassikaline sünteetilise kontrolli näide on California tubakakontrolli programmi – Proposition 99 – mõju analüüs. Tegemist oli 1988. aastal vastuvõetud seadusandliku paketiga, mis tõstis sigarettide aktsiisi 25 sendi võrra paki kohta ja suurendas makse ka teistele tubakatoodetele. Osa maksutulust suunati ulatusliku tubakakontrolli programmi rahastamiseks, mille eesmärk oli vähendada suitsetamist ning parandada rahvatervist.

Paneelandmestik sisaldab 39 USA osariigi andmeid perioodil 1970–2000. California puhul võeti 1988. aastat kui sekkumishetke, seega sekkumiseelne periood hõlmab aastaid 1970–1988. Sünteetiline kontroll konstrueeriti kaalutud kombinatsioonina teistest osariikidest, kus sarnane tubakakontrolli programm puudus. Sobitamisel kasutati mitmeid selgitavaid tunnuseid, näiteks elaniku kohta arvutatavat sissetulekut, sigarettide hinda, vanuselist struktuuri ning varasemate erimaksudega seotud näitajaid.

Kaalud selgitavad, kui suure panuse annab iga doonor-osariik sünteetilise California moodustamisse. Samuti määratakse tunnuste kaalud $V$, mis peegeldavad, millised tunnused on prognoosivõime seisukohast kõige olulisemad.

<!-- ![Sigarettide müük elaniku kohta Californias ja sünteetilises kontrollis](figures/california-synthetic-cig-sales.png) -->

Joonis kujutab California sigarettide müüki elaniku kohta koos sünteetilise kontrolli müügiga. Sekkumiseelsel perioodil peaksid need kaks aegrida olema üksteisele väga lähedal, mis kinnitab sobituse headust. Pärast sekkumist ilmneb järkjärguline lahknemine, mis näitab tubakakontrolliprogrammi mõju.

## Eeldused

Sünteetilise kontrolli meetodi korrektne tõlgendamine põhineb mitmel olulisel eeldusegrupil.

### Ei ole vastastikmõjusid (SUTVA-laadne eeldus)

Esimene eeldus puudutab vastastikmõjusid ehk üldise tasakaalumõju puudumist. Eeldame, et sekkumine käsitletaval objektil ei mõjuta otseselt kontrollobjektide tulemusi. Näiteks Baskimaa konflikti analüüsis eeldatakse, et konflikt ei mõjuta teiste Hispaania regioonide majanduskasvu. Teine näide oleks Eesti ettevõtte tulumaksumäära langetus, mille puhul eeldaksime, et see ei mõjuta naaberriikide ettevõtete majandusnäitajaid. See on sarnane SUTVA eeldusest tuntud nõudega, et ühe üksuse osalemine meetmes ei mõjuta teise üksuse tulemust.

Kui see eeldus ei kehti ja sekkumine „lekib” kontrollüksustesse, siis sünteetiline kontroll ei esinda enam korralikult võrdlusseisundit ilma sekkumiseta.

### Paralleelsete trendide analoog ja sekkumiseelsed perioodid

Teine oluliste eelduste rühm puudutab dünaamikat sekkumiseelsel perioodil. Nõuame, et kontrollgrupi tulemusi mõjutab sama struktuurne protsess, mis käsitletavat üksust, ning nii uuritav objekt kui ka kontrollüksused alluvad sarnastele šokkidele. See on analoog paralleelsete trendide eeldusele erinevuste vahe (dif-dif) meetodi puhul, kuid sünteetilise kontrolli korral kontrollime seda sobitamise abil.

Mida rohkem on sekkumiseelseid perioode, seda paremini on võimalik kontrollida nii vaadeldavate kui ka mittevaadeldavate tegurite mõju. Kui suudame sekkumiseelsel perioodil väga täpselt sobitada nii selgitavad tunnused kui ka tulemuste dünaamika, siis on usutav, et sama suhe püsib ka sekkumisjärgsel perioodil.

## Platseeboanalüüs ja tulemuste robustsus

Selleks, et veenda lugejat, et leitud tulemused ei ole juhuslikud, kasutatakse sünteetilise kontrolli kontekstis sageli platseeboanalüüse ja RMSPE-suhetega teste.

### Platseebod kontrollüksustele

Platseeboanalüüsi põhiidee seisneb selles, et rakendame sünteetilise kontrolli meetodit mitte ainult käsitletavale üksusele, vaid ka igale doonorgrupi üksusele. Iga kontrollüksuse jaoks konstrueerime sünteetilise versiooni, kasutades ülejäänud üksusi doonorina, ning „teeskleme”, et sekkumine toimus samal ajal ka selles kontrollüksuses.

Iga kontrollüksuse puhul võrdleme sekkumisjärgsel perioodil tegelikku tulemust selle sünteetilise kontrolliga. Kui tegelikult mingit mõju ei olnud, peaks nende kahe aegrea vahe jääma väikeseks ning olema sekkumiseelse perioodiga võrreldav. See loob nulljaotuse, millega saame võrrelda käsitletava üksuse kõrvalekallet.

Visuaalselt võime joonistada kõikide üksuste (käsitletava ja platseebode) trajektoorid ning nende erinevuse sünteetilisest kontrollist. Kui käsitletava üksuse kõrvalekalle on selgelt suurem kui enamikul platseebodel, viitab see tõsiseltvõetavale sekkumise efektile.

### RMSPE suhted ja p-väärtus

Platseeboanalüüsi saab kvantifitseerida ruutkeskmise prognoosivea suhete kaudu. Olgu käsitletava või platseebos üksuse korral:

$$ \text{RMSPE}\_{\text{pre}} = \sqrt{\frac{1}{T_0} \sum_{t=1}^{T_0} (Y_{it} - Y_{it}^{\text{SC}})^2}, $$

$$ \text{RMSPE}\_{\text{post}} = \sqrt{\frac{1}{T - T_0} \sum_{t=T_0+1}^{T} (Y_{it} - Y_{it}^{\text{SC}})^2}, $$

kus $Y_{it}^{\text{SC}}$ on sünteetilise kontrolli tulemus. Seejärel defineerime suhte:

$$ R_i = \frac{\text{RMSPE}_{\text{post}}}{\text{RMSPE}_{\text{pre}}}$$

Suhe $R_i$ suurem kui 1 viitab sellele, et sekkumisjärgne sobivus on halvem võrreldes sekkumiseelsega, ning suurem suhtarv tähendab suuremat eeldatavat sekkumise mõju. Arvutame selle suhte nii käsitletava üksuse kui ka kõikide platseebode jaoks ning järjestame need kahanevas järjekorras. Käsitletava üksuse positsioon selles jaotuses annabki täpse p-väärtuse:

$$ p = \frac{\#\{i : R_i \geq R_{\text{treated}}\}}{\text{kõigi üksuste arv}}. $$

California näites oli käsitletava üksuse (California) suhe kõige suurem kõigi osariikide seas, mis andis p-väärtuseks ligikaudu $1/38 \approx 0{,}026$. See tähendab, et vaid ühel juhul 38-st võiksime oodata vähemalt sama suurt kõrvalekallet, kui mõju tegelikult ei oleks.

<!-- ![RMSPE suhete jaotus käsitletava ja platseeboüksuste vahel](figures/rmspe-ratios-placebos.png) -->

<!-- Joonis peaks illustreerima, kuidas käsitletava üksuse RMSPE-suhe asub jaotuse ülemises otsas, samas kui enamikul platseeboüksustel on märksa väiksemad suhted. -->

## Tasakaalu kontroll

Kui kaalud $w$ ja $V$ on õigesti valitud, saavutatakse tasakaal nii selgitavate tunnuste kui ka sekkumiseelse dünaamika osas. See tähendab, et sünteetiline kontroll on iga üksiku selgitava tunnuse osas käsitletavale üksusele võimalikult sarnane ning et ka tulemismuutuja sekkumiseelne aegrida on käsitletava üksuse ja sünteetilise kontrolli vahel võimalikult ühtiv.

Praktilises rakenduses kontrollitakse tasakaalu tavaliselt nii tabelite kui ka graafikute abil. Tunnuste puhul võrreldakse käsitletava üksuse ja sünteetilise kontrolli keskmisi väärtusi; tulemismuutuja puhul vaadeldakse sekkumiseelse perioodi trajektoore. Hea tasakaal on eelduseks usutavatele mõjuhinnangutele.

<!-- ![Tunnuste tasakaal käsitletava ja sünteetilise kontrolli vahel](figures/balance-table-plot.png) -->

<!-- Joonis või tabel peaks näitama, et sünteetiline kontroll on mitmete oluliste tunnuste (näiteks SKP, hinnatase, struktuursed näitajad) osas käsitletava üksuse lähedal, samas kui suvalise üksiku kontrollriigiga võrreldes võiks erinevus olla oluliselt suurem. -->

<!-- ### Edasised arendused -->

<!-- Sünteetilise kontrolli meetodit on viimastel aastatel oluliselt edasi arendatud. Mõned olulisemad suunad on järgmised. -->

<!-- Esiteks on arendatud Bayesi lähenemisi sünteetilisele kontrollile, kus kaalude ja ebakindluse hindamine toimub Bayesi raamistikus. Teiseks on välja töötatud generaliseeritud sünteetilise kontrolli meetod (Generalized Synthetic Control, näiteks Xu ja Liu), mis võimaldab mitut käsitletavat üksust ning kasutab paneel-mudelite raamistikku. -->

<!-- Kolmandaks on ilmunud augmenteeritud lähenemised, mis ühendavad sünteetilise kontrolli ja erinevuste-vahe mõtlemise. Näiteks Arkhangelsky jt (2021) synthdid-paketis ja Ben-Michaeli jt (2021) Augmented Synthetic Control Method (ASCM) kombineerivad klassikalist sünteetilist kontrolli regressioonipõhiste parandustega (näiteks kantregressiooni või LASSO-regressioon) ning kõrgedimensiooniliste selgitavate tunnustega. Sellised lähenemised vähendavad sekkumiseelse sobituse väikeste jääkkõrvalekallete mõju ning võivad parandada efektiivsust. -->

<!-- Lõpuks on sündinud ka kõrgedimensioonilised variandid, mis kasutavad regulaarsustehnikaid ja masinõppemeetodeid (nt LASSO, juhumetsad) suure tunnuste arvu korral, kus klassikaline sünteetiline kontroll muutuks ebastabiilseks. -->

## Näide

R-keskkonnas on sünteetilise kontrolli rakendamiseks levinud paketid Synth ja SCtools, samuti uuemad paketid, mis realiseerivad üldistatud või augmenteeritud lähenemisi (nt synthdid, augsynth). Alljärgnev näide annab ülevaate klassikalise sünteetilise kontrolli rakendamisest ühe käsitletava ja mitme kontrollüksusega.

Kõigepealt on vajalik, et meil on paneelandmestik, kus igal real on üksus, aasta ja tulemusmuutuja ning tunnused:

```{r}
library(Synth) 
library(SCtools)

```

Me kasutame pakette `Synth` ja `SCtools` . Vt <https://cran.r-project.org/web/packages/Synth/index.html> ja <https://cran.r-project.org/web/packages/SCtools/index.html>

Põhiviide: Abadie A, Diamond A, Hainmueller J (2011). “Synth: An R Package for Synthetic Control Methods in Comparative Case Studies.” Journal of Statistical Software, 42(13), 1–17. <https://www.jstatsoft.org/v42/i13/>

Muud paketid: - kui mitu objekti `gsynth`, <https://cran.r-project.org/web/packages/gsynth/index.htm> - kui tahad kombineerida dif-dif analüüsiga

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(Synth)
library(SCtools)
library(foreign)

```

## Saksamaa taasühinemine

Andmed artiklist A. Abadie, A. Diamond, and J. Hainmueller. 2014. Comparative Politics and the Synthetic Control Method American Journal of Political Science. Viide https://economics.mit.edu/sites/default/files/publications/Comparative%20Politics%20and%20the%20Synthetic%20Control.pdf

Selles rakendame sünteetilise võrdlusobjekti meetodit, et hinnata 1990. aasta Saksamaa taasühinemise mõju majandusele. Tegu oli ühe olulisema poliitilis sündmusega sõjajärgses Euroopas. Pärast Berliini müüri langemist 9. novembril 1989 ühinesid Saksa Demokraatlik Vabariik ja Saksamaa Liitvabariik ametlikult 3. oktoobril 1990. Sel ajal oli Lääne-Saksamaa SKP elaniku kohta ligikaudu kolm korda kõrgem kui Ida-Saksamaal (Lipschitz ja McDonald 1990).

Meid huvitab, mis oli ühinemise mõju Lääne-Saksamaa SKP-le.

Laeme andmed

```{r}

#Muutke ära andmete kataloog
datapath = "http://kodu.ut.ee/~avork/files/oppetoo/pohjustagajarg/"

#Lugege sisse andmefail
d <- read.dta(file = paste0(datapath, "repgermany.dta"))


```

Vaatame pisut andmetele sisse.

Kasutame OECD riikide paneelandmeid perioodi 1960–2003 kohta. Saksamaa taasühinemine toimus 1990. aastal, mis annab 30-aastase sekkumiseelse perioodi. Valim lõpeb 2003. aastal, sest ligikaudu kümneaastast perioodi pärast taasühinemist võib pidada mõistlikuks piiriks usutavale prognoosiperioodile. Sünteetiline Lääne-Saksamaa konstrueeritakse doonorriikide hulgast valitud potentsiaalsete võrdlusriikide kaalutud keskmisena. Meie doonorriikide hulgas on valim 16 OECD liikmesriigist.

Tulemusmuutuja on riigi SKP inimese kohta (PPP) järgi korrigeeritud ja mõõdetud 2002. aasta USA dollarites. Taasühinemiseelseid tunnused: SKP elaniku kohta, inflatsioonimäär, tööstuse osakaal loodud lisandväärtusest, investeeringute määr, haridustase ja kaubanduse avatuse mõõdik.

Peamised tunnused: - index : riigi number - country : riigi nimi - year : aasta - gdp : SKP inimese kohta - infrate : inflatsioon - trade : kaubanduse avatus - schooling : haridustase - industry : tööstuse osakaal - invest60, 70, 80 - kodumaiste investeeringute suhe SKPsse, 5-aastased keskmised. Üks väärtus 1980 aasta kohal.

```{r}
head(d)

```

Mõned joonised

SKP inimese kohta

```{r}
#
d %>% 
  ggplot(aes(x = year, y = gdp, color = country)) +
  geom_line(aes(linetype=(index!=7))) + #joone tüüp on erinev index = 7 (West Germany jaoks)
  guides(linetype = "none") + #ei taha legendi joone tüübi kohta
  theme_light() + labs(x = "", y = "GDP per capita")

```

Vaadake ka teisi muutujaid. Asendage `gdp` teiste näitajatega. Vajadusel lisage geom_point() kui vaatlused on vaid mõne aasta kohta.

```{r}
d %>% 
  ggplot(aes(x = year, y = schooling, group = country, color = country)) +
  geom_line(aes(linetype=(index!=7))) + 
  geom_point() +
  guides(linetype = "none") + 
  theme_light()

```

### Käsud paketis

Tavaline käskude järjekord

1.  dataprep() - valmista ette andmed
2.  synth() - leia kaalud, tee sünteetiline võrdlusobjekt
3.  synth.tab(), gaps.plot(), and path.plot() - näita tulemusi
4.  paktist SCtools käsk generate.placebos - tee platseebo analüüs
5.  vaata tulemusi käskudega plot_placebos, mspe.plot, mspe.test

Andmete ettevalmistamine

```{r}
dataprep.out <-
  dataprep(
           foo = d,
           predictors    = c("gdp","trade","infrate"),
           dependent     = "gdp", #y variable
           unit.variable = 1, #first variable is index variable
           time.variable = 3, #third variable is time variable
    special.predictors = list(
      list("industry" ,1981:1990, c("mean")),
      list("schooling",c(1980,1985), c("mean")),
      list("invest80" ,1980, c("mean"))
    ),
           treatment.identifier = 7, #index = 7 is West Germany
           controls.identifier = unique(d$index)[-7], #all the rest numbers
           time.predictors.prior = 1981:1990, #time for normal predictors
           time.optimize.ssr = 1981:1990, #time period to minimize difference between outcome of treated and synthetic control
           unit.names.variable = 2, #names
           time.plot = 1960:2003 #whole time period
         )
```

Vaata üle objekt dataprep.out, mille me salvestasime. See loob lihtsalt kõik vajalikud andmemaatriksid ja vektorid.

```{r}
str(dataprep.out)

```

X0 – kontrollüksuste ennustajate maatriks. Tavaliselt on need aastate keskmised, vastavalt määratletule. Iga veerg on üks piirkond.

```{r}
dataprep.out$X0

```

X1 – vaadeldava üksuse andmevektor. Sama ajaperiood.

```{r}
dataprep.out$X1

```

Z0 – kontrollüksuste väljundmuutuja maatriks sekkumiseelses perioodis.

```{r}
dataprep.out$Z0
```

Ja vaadeldava üksuse puhul:

```{r}
dataprep.out$Z1
```

Joonistamiseks vajalikud andmed on salvestatud objektidesse Y1plot ja Y0plot.

Nüüd saame käivitada käsu synth, et leida optimaalsed kaalud, mis loovad uuritavale üksusele parima võimaliku sünteetilise kontrolli.

```{r}
synth.out <- synth(dataprep.out)

```

Tulemuste kokkuvõtteks on kolm mugavat funktsiooni.

Kõigi tabelite (V- ja W-kaalud ning sobivus käsitletud ja sünteetilise kontrolli vahel) saamiseks kasutame käsku synth.tab()

```{r}
synth.tables <- synth.tab(dataprep.res = dataprep.out,
                          synth.res = synth.out)
print(synth.tables)

```

-   tab.pred annab ennustajate väärtused käsitletud üksuse ja sünteetilise kontrolli jaoks, koos valimi keskmisega.
-   tab.v annab selgitavate muutujate kaalud.
-   tab.w annab piirkondade kaalud.

Pane tähele, et tab.loss sisaldab kahte väärtust:

W–kaotus, mis on seotud ennustajate (X) erinevustega. Mida rohkem X-e lisame, seda suurem see tavaliselt on, sest samad piirkonnakaalud ei pruugi sobida kõigi X-de jaoks. Mida väiksem väärtus, seda paremini on käsitletava X-id sobitatud sünteetilise kontrolli X-idega. See tuleneb w-kaalude optimeerimisest.

V–kaotus, mis on seotud tulemismuutuja sobivusega. Mida väiksem see väärtus, seda paremini kirjeldame tulemismuutuja varasemaid väärtusi. See on käsitletud üksuse sünteetilise kontrolli sekkumiseelne keskmine ruutprognoosiviga (MSPE). See MSPE tuleneb nii v- kui w-kaalude optimeerimisest.

Tulemismuutuja trajektooride kokkuvõttegraafikute loomiseks (käsitletud ja sünteetiline üksus) kasutame käske path.plot() ja gaps.plot()

Tase:

```{r}
#to plot in levels (treated and synthetic)
path.plot(dataprep.res = dataprep.out,synth.res = synth.out)
## plot the gaps (treated - synthetic)
```

Erinevus:

```{r}
gaps.plot(dataprep.res = dataprep.out,synth.res = synth.out)

```

Platseebode genereerimiseks kasutame paketti SCtools. See kohtleb iga piirkonda kordamööda kui osalejat ja arvutab mõjud. See võtab mõnevõrra aega.

```{r}
placebos <- generate.placebos(dataprep.out, synth.out, Sigf.ipop = 3, strategy = "multicore") #multicore - quicker, parallel computing

```

Pärast seda saame joonistada platseebomõjud.

```{r}
plot_placebos(placebos)
```

Näeme, et mõned teisedki riigid kogesid langust alates 1990ndatest. Samuti saame arvutada sekkumisjärgse MSPE ja sekkumiseelse MSPE suhte. Mida suurem on see erinevus, seda keerulisem on tulevikku prognoosida võrreldes minevikuga. Kui paljud riigid saavad suure suhte, võib meie hinnatud mõju olla lihtsalt juhuslik variatsioon.

```{r}
mspe.plot(placebos)
```

Mitte ühelgi riigil ei ole suuremat kasvu MSPEs.

P-väärtus käsuga

```{r}
#or with the command
mspe.test(placebos)

```

Kontrolliks käsitsi kaotus sõltuvas tulemuses

```{r}
Y1plot <- dataprep.out$Y1plot
Y0plot <- dataprep.out$Y0plot
time <- dataprep.out$tag$time.plot
treat.time <- 1991
#ajad kaalutud kaotuse joaks
pre_idx <- which(time> 1980 & time< treat.time)

#Kontrolliks, mis aastad
time[pre_idx]

#Kaalud
w <- synth.tables$tab.w$w.weights 

#Sünteetiline keskmine
Y_synth_pre <- Y0plot[pre_idx, ] %*% w

#Kontrolliks
plot(pre_idx, Y_synth_pre, type = "l")

#erinevus
gaps_pre <- Y1plot[pre_idx] - Y_synth_pre

#Kontrolliks
plot(pre_idx, gaps_pre, type = "l")

#Käsitsi kaotus Y-s
lossV_manual <- mean(gaps_pre^2)
as.numeric(lossV_manual)

#Meil
synth.tables$tab.loss

```

```{r eval=FALSE, include=FALSE}
#Lisa - California näide

smoking <- read.csv("https://kodu.ut.ee/~avork/files/oppetoo/micro/smoking.csv")
smoking$statetreated = ifelse(smoking$state ==3, 'California' , 'Rest')

smoking %>%  ggplot(aes(x = year, y = cigsale, group = state, color = statetreated)) +
  geom_line() +
  scale_color_discrete(type = c("red", "grey")) + 
  labs(x = "", y = "Cigarette sales per capita", color = "") +
  theme_light() +
  geom_vline(xintercept = 1988)
                      
#Kontrollmuuutjad   - beer 1984-1988; lnincome , retprice, age15to24 in 1980-1988;  cigsale(1988) cigsale(1980) cigsale(1975)

dataprep.outsmoking <- dataprep(
  foo = smoking,
  unit.variable = c("state"),
  unit.names.variable = c("statenames"), #
  time.variable = c("year"),
  treatment.identifier = 3,
  controls.identifier = c(2,4:39),
  dependent = c("cigsale"), #dependent variable
  predictors= c("lnincome", "retprice", "age15to24"), #normal predictor
  time.predictors.prior = c(1980:1988), #time for normal predictors
  predictors.op = c("mean"), #operator on predictors
  time.optimize.ssr = c(1980:1988), #time period to minimize difference between outcome of treated and synthetic control
  special.predictors = list( list("beer",1984:1988,c("mean")),
                             list("cigsale",1988,c("mean")),
                             list("cigsale",1980,c("mean")),
                             list("cigsale",1975,c("mean"))),
  time.plot = c(1970:2000) #time period for the dependant variable used for plotting
)

synth.outsmoking <- synth(dataprep.outsmoking)
synth.tablessmoking <- synth.tab(dataprep.res = dataprep.outsmoking,
                                synth.res = synth.outsmoking)

#Võrdle tulemusi õpikuga
synth.tablessmoking

path.plot(dataprep.res = dataprep.outsmoking,synth.res = synth.outsmoking)
gaps.plot(dataprep.res = dataprep.outsmoking,synth.res = synth.outsmoking)

#Platseebod - aeglane!
placebos2 <- generate.placebos(dataprep.outsmoking, synth.outsmoking, Sigf.ipop = 3)
plot_placebos(placebos2)
mspe.plot(placebos2)
mspe.test(placebos2)

#Mis on järeldus?

```
