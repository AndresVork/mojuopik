# Potentsiaalse tulemuse mudel

Potentsiaalse tulemuse mudel (*potential outcomes model*, POM) on põhjusliku mõju hindamise standardne raamistik statistikas ja majandusteaduses. Mudeli juured on Splawa-Neymani (1923), Roy (1951), Quandt’i (1958) ja Rubini (1974) töödes ning seda nimetatakse sageli Neyman–Rubin–Roy mudeliks. Majandusteadustes sai see populaarseks 1990ndatel.

Põhiidee on lihtne: enne poliitikameedet või sekkumist on igal indiviidil mitu võimalikku tulemust, sõltuvalt sellest, kas ta osaleb meetmes või mitte. Reaalses elus näeme iga indiviidi kohta vaid üht realiseerunud tulemust. Sellest tekib põhjuslikkuse „põhiprobleem”: me ei näe kunagi sama indiviidi samal ajal nii osalemas kui mitte-osalemas.

POM annab süsteemse raamistiku, kuidas defineerida huvipakkuvad suurused (ATE, ATT, ATU, CATE, LATE jne) ning milliste eelduste korral võime neid suuruseid tõlgendada põhjusliku mõju hinnangutena.

## Tähistused

### Meede ja tulemused

Olgu indiviid (i) jaoks meetmes osalemise tunnus

$$
D_i \in \{0,1\},
$$ kus $D_i = 1$ tähendab osalemist meetmes ja $D_i = 0$ mitteosalemist

Et majandusteadlased on võtnud üle meditsiinivaldkonna meetodit, siis nimetatakse tunnust $D$ inglise keeles *treatment*. Eesti keelde siiski me ei tõlgi seda kui ravi saamine, vaid pigem "meede" ja "meetmes osalemine".

Inimesed või ettevõtted, kes osalesid meetmes, nimetamegi "osalusrühm" või "osalusgrupp". Inimesed või ettevõtted, kes ei osalenud meetmes nimetame "võrdlusrühm" või "võrdlusgrupp"; vahel ka otse inglise keelest tõlkides "kontrollgrupp".

Defineerime potentsiaalsed tulemused ( *potential outcomes* ):

Meetmes osalemise korral:

$$ Y_i^1 \quad \text{tulemus, kui } D_i = 1, $$

Meetmes mitteosalemise korral:

$$ Y_i^0 \quad \text{tulemus, kui } D_i = 0. $$

Reaalselt jälgitav tulemus $Y_i$ on see, mis realiseerub. Kui inimene osaleb meetmes, siis näeme potentsiaalset tulemust meetmes osalemise korral. Kui inimene ei osale meetmes, siis näeme potentsiaalset tulemust meetmes mitteosalemise korral.

$$ Y_i = D_i \, Y_i^1 + (1 - D_i)\, Y_i^0 = Y_i^0 + D_i \, (Y_i^1-Y_i^0). $$

Alati on meil lisaks ka vektor individuaalseid tunnuseid, mida kasutame kas selgitamaks, mis tegurid mõjutavad meetmes osalemist $D$ või potentsiaalset tulemust $Y_i^1$ ja $Y_i^0$.

$$ X_i = (X_{i1}, X_{i2}, \dots, X_{ik}), $$

näiteks sugu, vanus, haridus, piirkond, varasem sissetulek jne.

Meetmes osalemine ($D$) võib olla määratud mitmel moel.

Meetmes osalemine võib olla täiesti juhuslik (eksogeenne). Näiteks eksperiment, kus osad kaupluse kliendid saavad juhuslikult allahindlust ja osad mitte, ja kaupluse omanik soovib analüüsida inimeste ostmise hinnatundlikkust. Või Töötukassas registreeritud osad töötud peavad tulema konsultandi juurde kontorisse tööd otsima, aga teised võivad ise otsida tööd.

Meetmes osalemine võib sõltuda jälgitavatest tunnustest $X$. Näiteks töötukassa annab tööturukoolitust neile töötutele, kellel on madalam haridustase või kes ei oska eesti keelt. Analüütikutena saame seda arvesse võtta.

Meetme osalemine võib sõltuda mittejälgitavatest tunnustest (mis omakorda on seotud tulemusega $Y$). Näiteks targemate juhtidega firmad oskavad taotleda Ettevõtluse ja Innovatsiooni Sihtasutuselt eksporditoetust, aga nad omavad ka ise paremaid väliskontakte. Meie analüütikutena aga ei saa mõõta firma juhtide oskusi. Me arvame, et firmade edukus on seotud eksporditoetusega, aga tegelikult on kõik heade juhtide töö tulemus.

Meetmes osalemise jaoks ei ole üldjuhul vaja keerukat struktuurset mudelit.

### Individuaalne mõju

Individuaalne põhjuslik mõju indiviidi (i) jaoks on defineeritud kui potentsiaalsete tulemuste vahe.

$$
\delta_i = Y_i^1 - Y_i^0.
$$

Sellist mõju ei saa kunagi otse mõõta, sest me ei näe sama indiviidi korraga kahes olekus. Me näeme vaid ühte seisundit. Teist seisundit nimetame ka võrdlusseisundiks või vastandseisundiks ( *counterfactual* - kontrafaktuaal).

Üksikisiku jaoks mõju hindamise asemel keskendume keskendume populatsiooni- või alampopulatsiooni keskmistele mõjudele.

## Huvipakkuvad keskmised mõjud

### ATE – keskmine mõju populatsioonis

Poliitikameetme keskmine mõju (*average treatment effect*, ATE) on defineeritud kui

$$
\text{ATE} = \mathbb{E}\big[ Y_i^1 - Y_i^0 \big]
           = \mathbb{E}\big[ Y_i^1 \big] - \mathbb{E}\big[ Y_i^0 \big].
$$

Tõlgendus: milline oleks keskmine tulemus, kui kogu populatsioon osaleks meetmes, võrreldes olukorraga, kui keegi ei osaleks meetmes. Või, milline oleks meetme oodatav mõju, kui võtame juhuslikult ühe inimese üldkogumist.

### ATT – keskmine mõju osalenutele

Keskmine mõju osalejate jaoks (*average treatment effect on the treated*, ATT) on

$$
\text{ATT} = \mathbb{E}\big[ Y_i^1 - Y_i^0 \mid D_i = 1 \big].
$$

Tõlgendus: kui palju muutuks tulemus nende jaoks, kes tegelikult osalesid, võrreldes hüpoteetilise olukorraga, kus just need samad inimesed ei oleks osalenud.

### ATU – keskmine mõju mitteosalenutele

Mitteosalenute keskmine mõju (*average treatment effect on the untreated*, ATU) on

$$
\text{ATU} = \mathbb{E}\big[ Y_i^1 - Y_i^0 \mid D_i = 0 \big].
$$

Tõlgendus: kui palju oleks muutunud mitteosalenute tulemused, kui just nemad oleksid meetmes osalenud.

### ATE seos ATT ja ATU-ga

Olgu

$$
p = \Pr(D_i = 1)
$$ 
osalenute osakaal populatsioonis. Siis on keskmine mõju populatsioonis (ATE) lihtsalt kaalutud keskmine mõjust osalenute (ATT) ja mitte-osalenute jaoks (ATU)

$$
\text{ATE} = p \cdot \text{ATT} + (1 - p) \cdot \text{ATU}.
$$

ATT ja ATU võivad olla erinevad, kui mõju on erinev eri sotsiaaldemograafilistes rühmades (nn heterogeenne mõju). Näiteks kui põhiharidusega inimeste jaoks on tööturukoolituse efekt suurem kui kõrgharidusega inimeste jaoks, aga koolitust saanute seas on põhiharidusega inimesi suhteliselt enam, siis ongi ATT suurem kui ATU. 


## Näited ATE, ATT ja ATU tõlgendamisest

Alljärgnevalt mõned rakendusnäited majandusest.

### Näide 1: Töötajate koolitusprogramm

-   Meede: ettevõte viib valitud töötajatele läbi edasijõudnute programmeerimiskoolituse.
-   Tulemus: tootlikkuse kasv (nt koodi kvaliteet ja kiirus).
-   Grupid:
    -   koolitatud: koolitusele valitud töötajad (D=1);
    -   koolitamata: töötajad, kes koolitust ei saanud (D=0).

Tõlgendused:

-   ATT:\
    Kui palju paranes tootlikkus koolitusel osalenud töötajatel võrreldes olukorraga, kus just need samad töötajad ei oleks koolitusel osalenud?
-   ATU:\
    Kui palju oleks muutunud tootlikkus töötajatel, kes ei osalenud, kui nemad oleksid koolituse saanud?
-   ATE:\
    Kui kõik töötajad oleks koolitatud, milline oleks keskmine tootlikkuse kasv ettevõttes?


### Näide 2: Turunduskampaania

-   Meede: ettevõte saadab valitud klientidele e-posti kampaania allahindlusega.
-   Tulemus: ostutõenäosuse või käibe muutus.

Tõlgendused:

-   ATT: milline oli müügi kasv kampaania saanud klientide seas (võrreldes olukorraga, kus need kliendid poleks pakkumist saanud)?
-   ATU: kui palju oleks muutunud kampaanias mitteosalenud klientide ostutõenäosus, kui neile oleks pakkumine saadetud?
-   ATE: mis oleks tulemus, kui kampaania saadetaks kõigile klientidele?

## Lihtne keskmiste erinevus ja nihe

### Lihtne erinevus tulemustes

Praktikas alustatakse sageli lihtsa keskmiste erinevuse arvutamisega osalus- ja võrdlusrühma jaoks kasutades nende tegelikke jälgitavaid tulemusi.

$$
\text{SDO} 
= \mathbb{E}[Y_i \mid D_i = 1] - \mathbb{E}[Y_i \mid D_i = 0],
$$

Inglise keeles SDO - *simple difference of outcomes*.

Tegelike andmete puhul asendame oodatavad väärtused andmete tegelike väärtustega. (Juhusliku suuruse realisatsiooni tähistame väikese tähega.)

$$
\text{SDO} 
= \frac{1}{N_T} \sum_{i=1}^{n} \left( y_i \mid d_i = 1 \right)
- \frac{1}{N_C} \sum_{i=1}^{n} \left( y_i \mid d_i = 0 \right)
$$

kus $N_T$ on meetmes osalenud inimeste arv ja $N_C$ on meetmes mitteosalenud inimeste arv.

Üldjuhul ei võrdu see ATE-ga, sest osalejad ja mitteosalejad erinevad süsteemselt omavahel (valikunihe) ning mõju võib olla erinev erinevate inimeste jaoks.

### Valikunihe ja nihe heterogeensest mõjust

SDO saame kirjutada alljärgneval kujul - liites ja lahutades liikme $\mathbb{E}\big[ Y_i^1 \mid D_i = 0 \big]$

$$
\begin{aligned}
\text{SDO} 
&= \mathbb{E}\big[ Y_i^1 \mid D_i = 1 \big] 
   - \mathbb{E}\big[ Y_i^0 \mid D_i = 0 \big] \\
&= \underbrace{\mathbb{E}\big[ Y_i^1 - Y_i^0 \mid D_i = 1 \big]}_{\text{ATT}}
   + \underbrace{\Big(\mathbb{E}\big[ Y_i^0 \mid D_i = 1 \big] 
   - \mathbb{E}\big[ Y_i^0 \mid D_i = 0 \big]\Big)}_{\text{valikunihe}}.
\end{aligned}
$$

Lihtne erinevus sisaldab seega kahte komponenti:

-   tõeline põhjuslik mõju osalenutele (ATT);
-   valikunihe (selection bias), mis tuleneb sellest, et osalenute ja mitteosalenute potentsiaalsed tulemused ilma meetmeta on erinevad.

Kui võrrelda SDO-d ja ATEd, siis tuleb lisaks nihe heterogeense mõju tõttu, sest ATT ja ATU võivad olla erinevad.

Et $\text{ATE} = p \cdot \text{ATT} + (1 - p) \cdot \text{ATU}$, siis liites ja lahutades ATT, saame kirjutada:

$$\begin{aligned}
\text{ATE}  
&= p \cdot \text{ATT} + \text{ATT} - \text{ATT} + (1 - p) \cdot \text{ATU} \\
&= \text{ATT} - (1-p) \cdot \text{ATT} + (1 - p) \cdot \text{ATU} \\
&= \text{ATT} - (1-p) \cdot (\text{ATT} - \text{ATU}) \\
\end{aligned}
$$

Seega saab kirjutada SDO välja järgmiste komponentide summana

$$
\begin{aligned}
\text{SDO} 
&= \mathbb{E}\big[ Y_i^1 \mid D_i = 1 \big] 
   - \mathbb{E}\big[ Y_i^0 \mid D_i = 0 \big] \\
&= \underbrace{\mathbb{E}\big[ Y_i^1 - Y_i^0 \big]}_{\text{ATE}}
   + \underbrace{\Big(\mathbb{E}\big[ Y_i^0 \mid D_i = 1 \big] 
   - \mathbb{E}\big[ Y_i^0 \mid D_i = 0 \big]\Big)}_{\text{valikunihe}} 
   + \underbrace{(1 - p) \cdot\Big(\text{ATT}-\text{ATU}\Big)}_{\text{nihe mõju heterogeensusest}}.
\end{aligned}
$$

Ehk kokkuvõttes:

$$
\text{SDO} = \text{ATE} + \text{valikunihe} + \text{nihe mõju heterogeensusest}.
$$

Ainult juhul, kui puudub valikunihe ja mõju ei ole heterogeenne, võime lihtsat osalusrühma ja võrdlusrühma väärtuste erinevust tõlgendada keskmise põhjusliku mõjuna.

## SUTVA – stabiilse ühikunäitaja eeldus

*Stable unit treatment value assumption* (SUTVA) koosneb kahest osast.

1.  Puuduvad interferentsid: ühe indiviidi osalemine ega tulemus ei sõltu sellest, kas teised indiviidid osalevad meetmes või mis on nende tulemus. Formaliseeritult potentsiaalsete tulemuste sõltumatus inimeste $i$ ja $j$ vahel\

$$
Y_i^1 \perp Y_j^1, \  Y_i^0 \perp Y_j^0
$$ ja meetmes osalemiste sõltumatus

$$
D_i \perp D_j
$$

2.  Puuduvad erinevad meetme versioonid: $D=1$ tähendab kõigi jaoks identset sekkumist.

SUTVA rikkumise näited:

-   kui üks töötutest osaleb koolitusel, see vähendab teiste töötute võimalust sama koolitust saada;
-   kui üks töötutest leiab töö, võib see vähendada teiste töötute töö leidmise tõenäosust (konkurents töökohtade pärast);
-   kui igal aastal koolitatakse suur hulk töötuid, võib see mõjutada palgataset kogu tööturul, muutes nii osalejate kui mitteosalejate palku (nn üldise tasakaalu efekt- general ).

SUTVA on POM-i keskne eeldus: ilma selle kehtivuseta ei saa potentsiaalseid tulemusi selgelt defineerida.

## Sõltumatuse eeldus

Sõltumatuse eeldus ( _independence assumption_ ) tähedab seda, et meetmes osalemine ei sõltu potentsiaalsetest tulemustest. 


$$
\big( Y_i^0, Y_i^1 \big) \;\perp\!\!\!\perp\; D_i
$$
Kõige lihtsam olukord on juhuslik eksperiment, kus meetmes osalemine määratakse loosiga. 

Majandusinimeste vaatevinklist on see rumal eeldus – miks peaks inimene otsustama osalemise ilma silmas pidamata võimalikku kasu? Inimesed otsustavad osaleda meetmes, pidades silmas oma eeldatavat kasu, toimub iseselektsioon ( _self-selection_ ), ning meedet pakkuvad töötajad võivad „koort riisuda” ( _cream skimming_ ), valides osalejateks motiveeritumaid või võimekamaid indiviide.

See on täidetud juhusliku eksperimendi korral. See võib olla osaliselt täidetud kui välised tegurid mõjutavad osalemist, nt seaduse muutused, COVID-19 vmt, kus inimene ise ei saa otsustada meetmes osalemist.

Kui sõltumatuse eeldus on täidetud, siis potentsiaalsed tulemused ei sõltu sellest, kas inimene osales meetmes või mitte.

Potentsiaalne tulemus mitteosalemise korral:

$$
\mathbb{E}[Y_i^0 \mid D_i = 1] = \mathbb{E}[Y_i^0 \mid D_i = 0],
$$
ja potentsiaalne tulemus osalemise korral:


$$
\mathbb{E}[Y_i^1 \mid D_i = 1] = \mathbb{E}[Y_i^1 \mid D_i = 0],
$$

ja sellisel juhul annab lihtne keskmiste erinevus (SDO) keskmise oodatava mõju ATE:

$$
\text{SDO} = \mathbb{E}[Y_i \mid D_i=1] - \mathbb{E}[Y_i \mid D_i=0] = \text{ATE}.
$$
Sellisel juhul puudub valikunihe ja nihe heterogeense mõju tõttu.


## Tingimusliku sõltumatuse eeldus

Tingimusliku sõltumatuse eeldus ( _conditional independence assumption_, CIA) ütleb, et kui võtame arvesse jälgitavad tunnused (X), siis osalemisotsus ei sõltu enam potentsiaalsetest tulemustest:

$$
\big( Y_i^0, Y_i^1 \big) \;\perp\!\!\!\perp\; D_i \mid X_i.
$$

Sarnased terminid kirjanduses:

-   unconfoundedness (Rosenbaum ja Rubin, 1983),
-   selection on observables (Barnow jt, 1980),
-   exogeneity (Imbens, 2004),
-   ignorability (Rubin, 1978).

CIA tähendab, et kui võtame arvesse piisavalt rikkalikku selgitavate tunnuste hulga (nt tööpoliitika meetme mõju hindamisel inimese sugu, vanus, haridus, varasem palgatase, varasem töötamise kogemus jne), siis meetmes osalemise otsus on nagu juhuslik.

### Tingimuslik keskväärtuse sõltumatus

Nõrgem versioon on tingimusliku keskväärtuse sõltumatuse eeldus:

$$
\mathbb{E}[ Y_i^0 \mid D_i=1, X_i = x] 
= \mathbb{E}[ Y_i^0 \mid D_i=0, X_i = x],
$$

$$
\mathbb{E}[ Y_i^1 \mid D_i=1, X_i = x] 
= \mathbb{E}[ Y_i^1 \mid D_i=0, X_i = x].
$$

See eeldus ütleb, et erinevused keskmistes potentsiaalsetes tulemustes kaovad osalus- ja võrdlusrühma vahel, kui vaatleme piisavalt kitsaid alamrühmi, ehkki jaotuste kujud võivad erineda. (Nt võib tinglik dispersioon olla erinev kahes rühmas.)


## Ühine tugi

CIA praktiline rakendamine nõuab ühist tuge ( _common support_ ):

$$
0 < \Pr(D_i = 1 \mid X_i = x) < 1
$$

kõigi huvipakkuvate $x$ jaoks.

Ühine tugi tähendab, et iga X väärtuse korral peab olema nii osalejaid kui mitteosalejaid. Ei tohi olla selliseid X-i alasid, kus kõik osalevad või ei osale. Vastasel juhul ei saa nendes alamrühmades väärset võrdlust teha.

Näiteks, kui kõik registreeritud töötud, kes on alla 24-aastased peavad osalema tööturukoolitusel, siis meil ei ole neid kellegagi võrrelda ja seega ei ole ühise toe eeldus täidetud.

Praktikas tähendab see ka seda, et ei tohi minna liiga detailsele tasemele väga paljude tunnuste ja kategooriatega, ning sageli kasutatakse pidevate tunnuste puhul intervalljaotust (nt sissetuleku kvantiilid) või vanus 5-aastastes vanusrühmades jm.

## ATT hindamine CIA abil

Kui CIA ja ühine tugi kehtivad, saame ATT väljendada jälgitavate suuruste abil. Üks võimalus on kirjutada

$$
\text{ATT}
= \mathbb{E}_{X \mid D=1} 
  \Big[ \mathbb{E}[Y_i \mid D_i = 1, X_i] 
       - \mathbb{E}[Y_i \mid D_i = 0, X_i] \Big].
$$

Selitus:

1.  jagame andmed (K) rühma X-vektori alusel (nt mehed, vanuses 40–60, kõrgharidusega; mehed, vanuses 40-60, keskharidusega jne);
2.  igas rühmas võrdleme osalenute ja mitteosalenute keskmisi tulemusi;
3.  võtame nende rühmakeskmiste erinevuste kaalutud keskmise, kus kaaludeks on osalenute struktuur osalusrühmas. 
(Analoogselt kasutame ATU jaoks kaaludena mitte-osalenute struktuuri.)

See on mitteparametriline lähenemine CIA eelduse rakendamiseks. Praktikas kasutatakse sageli ka:

-   regressioonimudeleid,
-   logistilist regressiooni osalemise tõenäosuse hindamiseks ja selle alusel sobitamisel (_propensity score matching_),
-   kaalumismeetodeid (_inverse probability weighting_),
-   või nende kombinatsioone.


## Muid statistikuid

### Meetme pakkumise mõju (Intention to treat effect - ITT)

Sageli ei saa me kontrollida, kas indiviid tegelikult meetmes osales. Teame vaid, ainult, kas talle pakuti meedet. Näiteks Töötukassa pakub kollektiivse koondamise puhul ettevõtetele ja nende töötajatele teabe jagamiseks kohtumisi, sh uute võimalike tööandjatega. Aga me ei tea täpselt, kes koondatutest nendel üritusel käisid.

Olgu (Z_i) indikaator, kas indiviidile pakuti osalemist. ITT on defineeritud siis kui oodatav erinevus väljundis inimeste vahel, kellele pakuti meedet ja kellele ei pakutud meedet. 

$$
\text{ITT} = \mathbb{E}[Y_i \mid Z_i = 1] - \mathbb{E}[Y_i \mid Z_i = 0].
$$

ITT mõõdab meetme pakkumise mõju, mitte tegeliku osalemise mõju ning võib olla oluline poliitikamõjude hindamisel, kui meetmes osalemine ei ole täielik.

ITT võib kirjutada ka

$$
\text{ITT}
= \text{ATT} \times \text{PR},
\qquad
\text{kus }
\text{PR}
= \frac{N_{\text{Tegelik osalejate arv meetmes}}}{N_{\text{Plaanitud osalejate arv}}}
$$



### Lokaalne keskmine mõju (LATE)

Instrumentmuutuja raamistikus saame määratleda lokaalse keskmise mõju ( _local average treatment effect_ - LATE) indiviididele, kes muudavad oma osalemiskäitumist instrumentmuutuja muutumise tõttu (compliers):

$$
\text{LATE}
= \frac{\mathbb{E}[Y_i \mid Z_i = 1] - \mathbb{E}[Y_i \mid Z_i = 0]}
       {\mathbb{E}[D_i \mid Z_i = 1] - \mathbb{E}[D_i \mid Z_i = 0]}.
$$

LATE on keskmine mõju nende indiviidide jaoks, kes „on piiri peal” ning kelle osalemine sõltub instrumendist (näiteks seadusemuudatusest vm).

Sellest räägime pikemalt instrumentmuutuja peatükis.

### Tingimuslik keskmine mõju (CATE)

Kui mõju on heterogeenne, võib meid huvitada tingimuslik keskmine mõju teatud X-väärtuse korral:

$$
\text{CATE}(x) 
= \mathbb{E}\big[ Y_i^1 - Y_i^0 \mid X_i = x \big].
$$

CATE võimaldab uurida näiteks:

-   kuidas erineb tööturukoolituse mõju vanusegruppide lõikes;
-   kuidas sõltub mõju varasemast palgatasemest;
-   millistele alarühmadele programm kõige rohkem kasu toob.


CATE-t vaatame põhjalikumalt kausaalmetsa (causal forest) korral.

## Kokkuvõte

Potentsiaalse tulemuse mudel formaliseerib põhjusliku mõju mõiste, kirjeldades iga indiviidi jaoks kahte potentsiaalset tulemust $Y_i^0$ ja $Y_i^1$. Kuna reaalses elus näeme ainult üht neist, keskendume erinevatele keskmistele mõjudele (ATE, ATT, ATU, CATE, LATE, ITT) ja eeldustele, mille alusel neid saab hinnata.

Lihtne keskmiste erinevus osalenute ja mitteosalenute vahel SDO on enamasti nihkes keskmise mõju jaoks valikunihke ja heterogeense mõju tõttu. Selleks, et anda põhjuslik tõlgendus, on vaja tugevaid eeldusi (nt juhuslik eksperiment) või realistlikumaid tingimuslikke eeldusi (CIA, ühine tugi) koos sobivate meetoditega (sobitamine, regressioonimudel, kaalumised).

POM on kooskõlas ka teiste lähenemistega, näiteks DAG-id (suunatud asüklilised graafid), mis keskenduvad eelkõige identifitseerimisele. Praktikas kasutatakse sageli POM-i raamistikku koos graafiliste mudelitega, et selgelt sõnastada nii eeldused kui ka hinnatav põhjuslik mõju.




## Ülesanded

### Ülesanne 1. 

On antud andmed 10 töötu kohta ja nende tulevase potentsiaalse palga kohta kaks aastat pärast töötuks jäämist, kui nad peaksid töötusperioodi ajal osalema kohustuslikult 3 kuud tööturukoolitusel.


| Isik | Y1   | Y0   | δ | D | Y    |
|:----:|:----:|:----:|:--:|:-:|:----:|
| 1    | 1200 | 1000 |    |   |      |
| 2    | 1000 | 1100 |    |   |      |
| 3    | 1000 | 300  |    |   |      |
| 4    | 1000 | 1200 |    |   |      |
| 5    | 800  | 400  |    |   |      |
| 6    | 1500 | 1000 |    |   |      |
| 7    | 1000 | 1500 |    |   |      |
| 8    | 1000 | 1100 |    |   |      |
| 9    | 900  | 1100 |    |   |      |
| 10   | 1400 | 1200 |    |   |      |

Selgitused:

- $Y_1$: palk, kui nad osaleksid meetmes  
- $Y_0$: palk, kui nad ei osaleks meetmes  
- $\delta = Y1 - Y0$: mõju koolitusest  
- $D$: koolituses osalemine (0/1)  
- $Y$: jälgitav tunnus (tegelik palk, sõltub $D$-st)

*Küsimused*

1. Arvuta igale inimesele oodatav kasu koolitusmeetmest $\delta = Y1 - Y0$.

2. Arvuta keskmine mõju meetmest (ATE):

   $$
   \text{ATE} = \frac{1}{n} \sum_{i=1}^{n} \delta_i.
   $$

3. Eeldame, et töötud teavad, milline on kasu koolitusest, ja koolituse võtavad vastu vaid need, kes sellest saavad kasu (st $\delta > 0$).  
   Mitu inimest võtavad koolituse vastu?

4. Mis on keskmine kasu koolitusest neile, kes koolituses tegelikult osalevad (ATT)?

   $$
   \text{ATT} = \mathbb{E}[\delta \mid D_i = 1].
   $$

5. Mis on keskmine kasu koolitusest neile, kes koolituses tegelikult ei osalenud (ATU)?

   $$
   \text{ATU} = \mathbb{E}[\delta \mid D_i = 0].
   $$

Meie analüütikutena ei näe mõlemat potentsiaalset väljundit ja näeme vaid seda olekut, mida töötu kasutas.

Arvuta:

6. SDO (simple difference in outcomes):

   $$
   \text{SDO} = \mathbb{E}[Y \mid D = 1] - \mathbb{E}[Y \mid D = 0].
   $$

7. Valikunihe (selection bias):

   $$
   \text{Valikunihe} = \mathbb{E}[Y_0 \mid D = 1] - \mathbb{E}[Y_0 \mid D = 0].
   $$

8. Mõju heterogeensus:

   $$
   \text{Mõju heterogeensus} = \text{ATT} - \text{ATU}.
   $$

9. Näita, et kehtib

   $$
   \text{SDO} 
   = \text{ATE} 
   + \text{valikunihe} 
   + (1 - p)\,(\text{ATT} - \text{ATU}),
   $$

   kus $p$ on meetmes osalenute osakaal.

10. Näita, et kehtib

    $$
    \text{SDO} = \text{ATT} + \text{valikunihe}.
    $$



<details>

<summary> Näita käsitsi lahendust </summary>

1. Individuaalsed mõjud $\delta_i$

$$
\delta_i = Y1 - Y0
$$

| Isik | Y1   | Y0   | δ  | D | Y    |
|:----:|:----:|:----:|:---:|:-:|:----:|
| 1    | 1200 | 1000 | 200 | 1 | 1200 |
| 2    | 1000 | 1100 | -100| 0 | 1100 |
| 3    | 1000 | 300  | 700 | 1 | 1000 |
| 4    | 1000 | 1200 | -200| 0 | 1200 |
| 5    | 800  | 400  | 400 | 1 | 800  |
| 6    | 1500 | 1000 | 500 | 1 | 1500 |
| 7    | 1000 | 1500 | -500| 0 | 1500 |
| 8    | 1000 | 1100 | -100| 0 | 1100 |
| 9    | 900  | 1100 | -200| 0 | 1100 |
| 10   | 1400 | 1200 | 200 | 1 | 1400 |

2. ATE

$$
\text{ATE}
= \frac{1}{10} (200 - 100 + 700 - 200 + 400 + 500 - 500 - 100 - 200 + 200)
= \frac{900}{10}
= 90.
$$

3. Kes võtavad koolituse vastu

Eeldusel, et koolituse võtavad vaid need, kelle $\delta > 0$, võtavad koolituse vastu isikud:

1, 3, 5, 6 ja 10 → kokku 5 inimest.

4. ATT

$$
\text{ATT}
= \frac{200 + 700 + 400 + 500 + 200}{5}
= \frac{2000}{5}
= 400.
$$

5. ATU

Mitteosalenute $\delta < 0$ indiviidid: 2, 4, 7, 8, 9.

$$
\text{ATU}
= \frac{-100 - 200 - 500 - 100 - 200}{5}
= \frac{-1100}{5}
= -220.
$$

6. SDO

$$
\text{SDO}
= \mathbb{E}[Y \mid D = 1] - \mathbb{E}[Y \mid D = 0].
$$

Osalejad (D = 1): isikud 1, 3, 5, 6, 10

$$
\mathbb{E}[Y \mid D = 1]
= \frac{1200 + 1000 + 800 + 1500 + 1400}{5}
= \frac{5900}{5}
= 1180.
$$

Mitteosalejad (D = 0): isikud 2, 4, 7, 8, 9

$$
\mathbb{E}[Y \mid D = 0]
= \frac{1100 + 1200 + 1500 + 1100 + 1100}{5}
= \frac{6000}{5}
= 1200.
$$

Seega

$$
\text{SDO} = 1180 - 1200 = -20.
$$

7. Valikunihe

$$
\text{Valikunihe}
= \mathbb{E}[Y_0 \mid D = 1] - \mathbb{E}[Y_0 \mid D = 0].
$$

$$
\mathbb{E}[Y_0 \mid D = 1]
= \frac{1000 + 300 + 400 + 1000 + 1200}{5}
= \frac{3900}{5}
= 780.
$$

$$
\mathbb{E}[Y_0 \mid D = 0]
= \frac{1100 + 1200 + 1500 + 1100 + 1100}{5}
= \frac{6000}{5}
= 1200.
$$

$$
\text{Valikunihe}
= 780 - 1200 = -420.
$$

8. Mõju heterogeensus

$$
\text{ATT} - \text{ATU}
= 400 - (-220)
= 620.
$$

9. Seos: SDO = ATE + valikunihe + (1 − p)·(ATT − ATU)

Osalejate osakaal $p = 5/10 = 0.5$.

Vasak pool:

$$
\text{SDO} = -20.
$$

Parem pool:

$$
\text{ATE} + \text{valikunihe} + (1 - p)\,(\text{ATT} - \text{ATU})
= 90 + (-420) + 0.5 \cdot 620
= 90 - 420 + 310
= -20
$$

Seega seos kehtib.

10. Seos: SDO = ATT + valikunihe

$$
\text{ATT} + \text{valikunihe}
= 400 + (-420)
= -20
= \text{SDO}
$$

Seega kehtib ka see seos.


</details>



<details>

<summary> Näita lahendust Ris </summary>

*Lahendus Ris*

```{r}
#| message: false
#| warning: false

require(dplyr)

#Teeme andmetabeliks
isik <- seq(1:10)
y1 <- c(1200, 1000, 1000, 1000, 800, 1500, 1000, 1000, 900, 1400)
y0 <- c(1000, 1100, 300, 1200, 400, 1000, 1500, 1100, 1100, 1200)
df <- data.frame(isik, y1, y0) 

# 1) Arvuta igale inimesele oodatav kasu koolitusmeetmest
df <- df %>% mutate(delta = y1-y0)

# 2) Arvuta keskmine mõju meetmest – ATE
ate= mean(df$delta)
ate

#Või
#df %>% summarise(ate = mean(delta)) %>% pull(ate)

# 3) Eeldame, et töötud teavad, milline on kasu koolitusest, ja iga koolituse võtavad vastu vaid need, kes sellest saavad kasu.
# Mitu inimest võtavad koolituse vastu?

df$d = ifelse(df$delta>0,1,0)

#või
#df <- df %>% 
#  mutate(d = ifelse(delta >0,1,0))

table(df$d)
#või
table(df$delta>0)

# 4) Mis on keskmine kasu koolitusest neile, kes koolituses tegelikult osalevad? ATT
att = mean(df$delta[df$delta>0])
att
#Või
(att2 <- df %>% filter(delta>0) %>% 
  summarise(att = mean(delta)) %>% 
  pull(att))


# 5) Mis on keskmine kasu koolitusest neile, kes koolituses tegelikult ei osalenud? ATU
atu = mean(df$delta[df$delta<0])
atu

# 6) SDO
#Erinevus jälgitavates tulemustes
#SDO = E(Y1|D=1) - E(Y0|D=0)

sdo = mean(df$y1[df$d == 1]) - mean(df$y0[df$d == 0]) 
sdo

# 7) Valikunihe
#E(Y0|D=1) - E(Y0|D=0)
valikunihe = mean(df$y0[df$d == 1]) - mean(df$y0[df$d == 0]) 
valikunihe

# 8) Mõju heterogeensus (1-pii)*(ATT-ATU)
hetnihe = (1-sum(df$d)/nrow(df)) * (att - atu)
hetnihe

# 9) Näita, et kehtib. SDO = ATE + valikunihe + (1-meetmes osalenute osakaal)*nihe mõju heterogeensusest
sdo
ate + valikunihe + hetnihe
#Kehtib

# 10) Näita, et kehtib SDO = ATT + valikunihe
att + valikunihe
#Kehtib

```

</details>


### Ülesanne 2.

Rahvusvaheline firma viis läbi oma ühe allüksuse müügiagentide seas müügikoolituse. Et hinnata müügikoolituse mõju, jagati osalejad juhuslikult kahte rühma piirkonna lõikes: ühed said koolitust (osalusgrupp) ja teised ei saanud (võrdlusgrupp). 

Koolituse mõju hindamiseks kasutatav näitaja oli keskmine palgale juurde makstav tulemustasu järgneva 12 kuu jooksul, mis sõltus otseselt inimeste personaalselt sõlmitud lepingutest. Andmed on toodud järgmises tabelis.

*Andmed pärast koolitust*

| Piirkond    | Grupp         | Inimesed, keda jälgiti | Keskmine tulemustasu |
|:------------|:--------------|------------------------:|--------------------:|
| Põhja-Eesti | Osalusgrupp   |                      40 |                 150 |
| Põhja-Eesti | Võrdlusgrupp  |                      30 |                 120 |
| Lõuna-Eesti | Osalusgrupp   |                      20 |                 150 |
| Lõuna-Eesti | Võrdlusgrupp  |                      10 |                 140 |

Leidke eraldi piirkondade lõikes ja kogu firmas, eeldades CIA kehtivust (conditional independence assumption) ning kasutades osalus- ja võrdlusgrupi diferents-hinnangut:

1. Mõju osalusgrupile (average treatment effect on treated – ATT)  
2. Mõju võrdlusgrupile, kui ta oleks osalenud (average treatment effect on untreated – ATU)  
3. Oodatav mõju kogu firmale, kui kõik oleksid osalenud (average treatment effect – ATE)  
4. Arutlege, kas mõju hindamiseks vajalikud eeldused on täidetud.


*Täiendav info ja teine olukord* 

Tagantjärgi selgus, et analüütik tegi vea ja inimeste jagamine ei olnud päris juhuslik, vaid selle otsustas personalitöötaja. Seega ei saanud eeldada, et inimeste võimekus oli ühesugune. 

Analüüsi parandamiseks võeti kasutusele koolituseelsed müüginumbrid, mis olid järgmised.

*Andmed enne koolitust*

| Piirkond    | Grupp         | Keskmine tulemustasu enne koolitusi |
|:------------|:--------------|------------------------------------:|
| Põhja-Eesti | Osalusgrupp   |                                 140 |
| Põhja-Eesti | Võrdlusgrupp  |                                 120 |
| Lõuna-Eesti | Osalusgrupp   |                                 140 |
| Lõuna-Eesti | Võrdlusgrupp  |                                 160 |


Millised võiksid olla ATT, ATU ja ATE hinnangud nüüd, kasutades väljundina tulemustasu **muutust** (pärast koolitust miinus enne koolitust):

1.ATT: keskmine mõju nendele, kes osalesid koolitusel  
2. ATU: keskmine mõju nendele, kes ei osalenud, kui nad oleksid osalenud  
3. ATE: oodatav keskmine mõju kogu firmale, kui kõik oleksid osalenud



<details>

<summary> Näita lahendust Ris </summary>

*Lahendus Ris*


```{r}
#Teeme lähteandmed Ri andmetabeliks
piirkond <- c("Pohi", "Louna")
osalus_n <- c(40, 20)
vordlus_n <- c(30, 10)
osalus_y <- c(150, 150)
vordlus_y <- c(120, 140)

df <- data.frame(piirkond, osalus_n, vordlus_n, osalus_y, vordlus_y)

df

# Leidke eraldi piirkondade lõikes ja kogu firmas, eeldades CIA kehtivust (conditional independence assumption) ning kasutades osalus- ja võrdlusgrupi erinevust
df$moju <- df$osalus_y-df$vordlus_y
df$moju

#Kaalud
df <- df %>% 
  mutate(kaal_ate = (osalus_n + vordlus_n) / sum(osalus_n + vordlus_n),
         kaal_att = osalus_n / sum(osalus_n),
         kaal_atu = vordlus_n / sum(vordlus_n))

# 1)	Mõju osalusgrupile (average treatment effect on treated - ATT)
# 2)	Mõju võrdlusgrupile, kui ta oleks osalenud (average treatment effect on untreated - ATU)
# 3)	Oodatav mõju kogu firmale, kui kõik oleksid osalenud (average treatment effect - ATE) 

df %>% summarise(att = sum(moju*kaal_att),
                 atu = sum(moju*kaal_atu),
                 ate = sum(moju*kaal_ate))


# Tagantjärgi täeindav info
osalus_y_enne <- c(140, 120)
vordlus_y_enne <- c(140, 160)

df <- df %>% bind_cols(data.frame(osalus_y_enne,vordlus_y_enne))

df

#Muutus müügis
df <- df %>% mutate(
  osalus_dy = osalus_y - osalus_y_enne, 
  vordlus_dy = vordlus_y- vordlus_y_enne,
  moju_dy = osalus_dy- vordlus_dy)
  
#Arvestades muutust
df %>% summarise(att = sum(moju_dy*kaal_att),
                 atu = sum(moju_dy*kaal_atu),
                 ate = sum(moju_dy*kaal_ate))


```

</details>

